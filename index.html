<!DOCTYPE html>
<html lang="en" class="h-full transition-colors duration-300">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Universal AI Chat</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            lightbg: '#f7f8fa',
            darkbg: '#1e1f23',
            darkpanel: '#2a2b31'
          }
        }
      }
    }
  </script>

  <!-- Marked -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html, body { height:100%; }

    #messages { scroll-behavior:smooth; }

    pre {
      background:#111827;
      color:#f9fafb;
      padding:1rem;
      border-radius:8px;
      overflow-x:auto;
    }

    .dark pre {
      background:#0f172a;
    }

    /* Gemini Toggle Animation */
    .toggle-ball {
      transition: transform 0.3s ease;
    }

    .dark .toggle-ball {
      transform: translateX(22px);
    }

    .icon {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .dark .sun {
      opacity:0;
      transform: rotate(90deg);
    }

    .dark .moon {
      opacity:1;
      transform: rotate(0deg);
    }

    .sun {
      opacity:1;
    }

    .moon {
      opacity:0;
      transform: rotate(-90deg);
    }
  </style>
</head>

<body class="min-h-screen flex bg-lightbg dark:bg-darkbg text-gray-900 dark:text-gray-100 transition-colors duration-300">

<!-- LOADER -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-darkbg z-50">
  <div class="text-lg font-semibold">Loading App...</div>
</div>

<!-- SIDEBAR -->
<div id="sidebar"
class="fixed md:relative z-40 md:z-0 inset-y-0 left-0 w-72
bg-white dark:bg-darkpanel
border-r border-gray-200 dark:border-gray-700
transform -translate-x-full md:translate-x-0
transition-all duration-300 flex flex-col">

  <div class="p-4 flex justify-between items-center border-b dark:border-gray-700">
    <h1 class="font-semibold">Chats</h1>
    <button onclick="newChat()" class="text-blue-500 text-sm">+ New</button>
  </div>

  <div id="chatList" class="flex-1 overflow-y-auto"></div>

  <div class="p-3 border-t dark:border-gray-700 space-y-3">

    <!-- Gemini Animated Toggle -->
    <div class="flex items-center justify-between">
      <span class="text-sm">Theme</span>
      <button onclick="toggleDarkMode()"
        class="relative w-14 h-8 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center px-1 transition">

        <div class="absolute left-2 sun icon">
          ‚òÄÔ∏è
        </div>

        <div class="absolute right-2 moon icon">
          üåô
        </div>

        <div class="toggle-ball w-6 h-6 bg-white rounded-full shadow"></div>
      </button>
    </div>

    <button onclick="openSettings()" class="w-full text-sm bg-gray-200 dark:bg-gray-700 p-2 rounded">
      Settings
    </button>

  </div>
</div>

<!-- MAIN -->
<div class="flex-1 flex flex-col min-h-screen">

  <!-- HEADER -->
  <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-darkpanel flex items-center justify-between">
    <button onclick="toggleSidebar()" class="md:hidden text-xl">‚ò∞</button>
    <h2 id="chatTitle" class="font-medium">New Chat</h2>
  </div>

  <!-- MESSAGES -->
  <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 pb-32"></div>

  <!-- INPUT -->
  <div class="fixed bottom-0 left-0 md:left-72 right-0
  bg-white dark:bg-darkpanel
  border-t border-gray-200 dark:border-gray-700 p-3">

    <div class="flex items-end gap-2">
      <textarea id="userInput" rows="1"
      placeholder="Message AI..."
      class="flex-1 resize-none p-3 rounded-lg bg-gray-100 dark:bg-gray-700 outline-none"></textarea>

      <button onclick="sendMessage()"
      class="bg-blue-600 text-white px-4 py-2 rounded-lg">
      Send
      </button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsModal"
class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">

  <div class="bg-white dark:bg-darkpanel p-6 rounded-lg w-96 space-y-4">
    <h3 class="font-semibold text-lg">Settings</h3>

    <input id="apiKeyInput" type="password"
    placeholder="OpenRouter API Key"
    class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700"/>

    <input id="modelInput"
    placeholder="Model Name"
    value="deepseek/deepseek-r1:free"
    class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700"/>

    <textarea id="systemPromptInput"
    placeholder="System Prompt"
    class="w-full p-2 rounded bg-gray-100 dark:bg-gray-700"></textarea>

    <div class="flex justify-end gap-2">
      <button onclick="closeSettings()">Cancel</button>
      <button onclick="saveSettings()"
      class="bg-blue-600 text-white px-3 py-1 rounded">Save</button>
    </div>
  </div>
</div>

<script>
let chats = JSON.parse(localStorage.getItem("chats") || "[]");
let currentChatId = localStorage.getItem("currentChatId");

function initTheme(){
  const saved = localStorage.getItem("darkMode");
  if(saved===null){
    if(window.matchMedia("(prefers-color-scheme: dark)").matches){
      document.documentElement.classList.add("dark");
      localStorage.setItem("darkMode","true");
    }
  } else if(saved==="true"){
    document.documentElement.classList.add("dark");
  }
}

function toggleDarkMode(){
  const isDark=document.documentElement.classList.toggle("dark");
  localStorage.setItem("darkMode",isDark.toString());
}

function init(){
  if(!currentChatId)newChat();
  renderChatList();
  renderMessages();
  initTheme();
  document.getElementById("loading").style.display="none";
}

function save(){
  localStorage.setItem("chats",JSON.stringify(chats));
  localStorage.setItem("currentChatId",currentChatId);
}

function newChat(){
  const id=Date.now().toString();
  chats.push({id,title:"New Chat",messages:[],system:""});
  currentChatId=id;
  save();
  renderChatList();
  renderMessages();
}

function getCurrentChat(){
  return chats.find(c=>c.id===currentChatId);
}

function renderChatList(){
  const list=document.getElementById("chatList");
  list.innerHTML="";
  chats.forEach(chat=>{
    const div=document.createElement("div");
    div.className="p-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between cursor-pointer";
    div.innerHTML=`
      <span onclick="selectChat('${chat.id}')">${chat.title}</span>
      <div class="flex gap-2 text-xs">
        <button onclick="renameChat('${chat.id}')">‚úè</button>
        <button onclick="deleteChat('${chat.id}')">üóë</button>
      </div>
    `;
    list.appendChild(div);
  });
}

function selectChat(id){
  currentChatId=id;
  save();
  renderMessages();
}

function renameChat(id){
  const name=prompt("Rename chat:");
  if(!name)return;
  chats.find(c=>c.id===id).title=name;
  save();
  renderChatList();
}

function deleteChat(id){
  chats=chats.filter(c=>c.id!==id);
  if(currentChatId===id)currentChatId=null;
  save();
  if(!currentChatId)newChat();
  renderChatList();
  renderMessages();
}

function renderMessages(){
  const container=document.getElementById("messages");
  container.innerHTML="";
  const chat=getCurrentChat();
  if(!chat)return;

  document.getElementById("chatTitle").innerText=chat.title;

  chat.messages.forEach(msg=>{
    const div=document.createElement("div");
    div.className=msg.role==="user"?"text-right":"text-left";

    div.innerHTML=`
      <div class="inline-block p-3 rounded-lg max-w-xl ${
        msg.role==="user"
        ?"bg-blue-600 text-white"
        :"bg-gray-100 dark:bg-gray-700"
      }">
      ${marked.parse(msg.content)}
      </div>
    `;
    container.appendChild(div);
  });

  container.scrollTop=container.scrollHeight;
}

async function sendMessage(){
  const input=document.getElementById("userInput");
  const content=input.value.trim();
  if(!content)return;
  input.value="";

  const chat=getCurrentChat();
  chat.messages.push({role:"user",content});
  renderMessages();
  save();

  await streamAI(chat);
}

async function streamAI(chat){
  const apiKey=localStorage.getItem("apiKey");
  const model=localStorage.getItem("model")||"deepseek/deepseek-r1:free";
  if(!apiKey)return alert("API Key required.");

  const response=await fetch("https://openrouter.ai/api/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+apiKey
    },
    body:JSON.stringify({
      model:model,
      stream:true,
      messages:[...chat.messages]
    })
  });

  const reader=response.body.getReader();
  const decoder=new TextDecoder();
  let aiMsg={role:"assistant",content:""};
  chat.messages.push(aiMsg);
  renderMessages();

  while(true){
    const {done,value}=await reader.read();
    if(done)break;
    const chunk=decoder.decode(value);
    chunk.split("\n").forEach(line=>{
      if(line.startsWith("data: ")){
        const json=line.replace("data: ","");
        if(json==="[DONE]")return;
        try{
          const parsed=JSON.parse(json);
          const token=parsed.choices?.[0]?.delta?.content;
          if(token){
            aiMsg.content+=token;
            renderMessages();
          }
        }catch{}
      }
    });
  }
  save();
}

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("-translate-x-full");
}

function openSettings(){
  document.getElementById("settingsModal").classList.remove("hidden");
  document.getElementById("apiKeyInput").value=localStorage.getItem("apiKey")||"";
  document.getElementById("modelInput").value=localStorage.getItem("model")||"deepseek/deepseek-r1:free";
}

function closeSettings(){
  document.getElementById("settingsModal").classList.add("hidden");
}

function saveSettings(){
  localStorage.setItem("apiKey",document.getElementById("apiKeyInput").value);
  localStorage.setItem("model",document.getElementById("modelInput").value);
  closeSettings();
}

init();
</script>
</body>
</html>
