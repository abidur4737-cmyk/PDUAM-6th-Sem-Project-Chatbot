<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#F0F4F9',
                            100: '#E1E6EC',
                            200: '#D3D9DF',
                            500: '#1A73E8', // Google Blue
                            800: '#1F1F1F', // Dark bg
                            900: '#131314'  // Darker bg
                        }
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                maxWidth: '100%',
                            }
                        }
                    })
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Typography & Scrollbars */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Markdown Styles */
        .prose pre { background-color: #1e1e1e !important; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; overflow-x: auto; }
        .prose code { color: #eb5757; background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; font-size: 0.9em; font-family: monospace; }
        .dark .prose code { color: #ff7b72; background: rgba(255,255,255,0.1); }
        .prose pre code { color: inherit; background: transparent; padding: 0; }
        .prose p { margin-bottom: 0.75em; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75em; }
        .prose strong { font-weight: 600; }
        
        /* Cursor Animation */
        .typing-cursor::after {
            content: '●';
            color: #1A73E8;
            animation: blink 1s infinite;
            margin-left: 4px;
            font-size: 0.8em;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* Loader */
        #loading-screen {
            position: fixed; inset: 0; background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .dark #loading-screen { background: #131314; color: white; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .dark .spinner { border-color: #333; border-top-color: #3498db; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Utility */
        .glass { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gemini-50 text-slate-800 dark:bg-gemini-900 dark:text-slate-200 h-[100dvh] overflow-hidden flex transition-colors duration-200">

    <div id="loading-screen">
        <div class="spinner mb-4"></div>
        <div class="font-medium opacity-70">Initializing Interface...</div>
    </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-gemini-100 dark:bg-gemini-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col border-r border-slate-200 dark:border-slate-700 shadow-xl md:shadow-none md:relative">
        <div class="p-4">
            <button onclick="app.createNewChat()" class="w-full flex items-center gap-3 bg-gemini-50 dark:bg-gemini-900 hover:bg-white dark:hover:bg-black p-3 rounded-full shadow-sm transition-all border border-transparent hover:border-slate-200 dark:hover:border-slate-600 text-sm font-medium">
                <i class="fas fa-plus text-gemini-500"></i>
                <span>New Chat</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-list">
            </div>

        <div class="p-4 border-t border-slate-200 dark:border-slate-700">
            <button onclick="app.toggleSettings()" class="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white p-2 w-full rounded hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                <i class="fas fa-cog"></i> Settings
            </button>
            <div class="mt-2 text-xs text-center text-slate-400">v1.0.0 • No-Build Arch</div>
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass"></div>

    <main class="flex-1 flex flex-col h-full relative w-full">
        
        <header class="flex items-center justify-between px-4 py-3 bg-gemini-50/90 dark:bg-gemini-900/90 backdrop-blur z-20 sticky top-0 border-b border-transparent dark:border-slate-800">
            <div class="flex items-center gap-3">
                <button onclick="app.toggleSidebar()" class="md:hidden p-2 text-slate-600 dark:text-slate-300">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <span id="current-model-display" class="text-sm font-medium text-slate-500 dark:text-slate-400 flex items-center gap-2 cursor-pointer hover:text-slate-800 dark:hover:text-slate-200" onclick="app.toggleSettings()">
                    DeepSeek R1 <i class="fas fa-chevron-down text-xs"></i>
                </span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="app.toggleTheme()" class="w-9 h-9 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-600 dark:text-slate-300">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-4">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center opacity-50 select-none">
                <div class="text-5xl mb-4 bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
                    <i class="fas fa-sparkles"></i>
                </div>
                <h2 class="text-2xl font-semibold mb-2 dark:text-white">How can I help you today?</h2>
                <p class="text-sm max-w-xs mx-auto">I can generate code, write essays, or help you brainstorm.</p>
            </div>
        </div>

        <div class="bg-gradient-to-t from-gemini-50 via-gemini-50 to-transparent dark:from-gemini-900 dark:via-gemini-900 pt-6 pb-4 px-4 flex-shrink-0">
            <div class="max-w-4xl mx-auto relative">
                <form id="chat-form" onsubmit="app.handleSubmit(event)" class="bg-white dark:bg-gemini-800 rounded-3xl shadow-lg border border-slate-200 dark:border-slate-700 flex items-end p-2 transition-all focus-within:ring-2 focus-within:ring-blue-500/50">
                    
                    <button type="button" class="p-3 text-slate-400 hover:text-blue-500 transition-colors rounded-full flex-shrink-0" title="System Prompt" onclick="app.toggleSystemPrompt()">
                        <i class="fas fa-robot"></i>
                    </button>

                    <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 resize-none py-3 px-2 max-h-32 text-slate-800 dark:text-slate-100 placeholder-slate-400 leading-normal" placeholder="Message Universal AI..." required oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    
                    <button type="submit" id="send-btn" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-all disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95 mb-0.5 flex-shrink-0 w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </form>
                <div class="text-center mt-2 text-[10px] text-slate-400 dark:text-slate-500">
                    AI can make mistakes. Please verify important information.
                </div>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gemini-800 rounded-2xl w-full max-w-md m-4 p-6 shadow-2xl transform transition-all border border-slate-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-sliders-h"></i> Settings</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">OpenRouter API Key</label>
                    <div class="relative">
                        <input type="password" id="api-key-input" class="w-full p-3 rounded-lg border dark:border-slate-600 bg-slate-50 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" placeholder="sk-or-...">
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Key is stored securely in your browser's LocalStorage.</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Model ID</label>
                    <input type="text" id="model-input" class="w-full p-3 rounded-lg border dark:border-slate-600 bg-slate-50 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="deepseek/deepseek-r1:free">
                    <p class="text-xs text-slate-500 mt-1">Example: <code class="bg-slate-100 dark:bg-slate-900 px-1 rounded">google/gemini-2.0-flash-lite-preview-02-05:free</code></p>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="app.toggleSettings()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
                <button onclick="app.saveSettings()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg shadow-md transition-colors">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="system-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gemini-800 rounded-2xl w-full max-w-lg m-4 p-6 shadow-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-robot"></i> System Instructions</h3>
            <p class="text-sm text-slate-500 mb-2">Define how the AI should behave for this specific chat.</p>
            
            <textarea id="system-prompt-input" rows="5" class="w-full p-3 rounded-lg border dark:border-slate-600 bg-slate-50 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none resize-none placeholder-slate-400" placeholder="Ex: You are a helpful Python coding assistant. Concise answers only."></textarea>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="app.toggleSystemPrompt()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
                <button onclick="app.saveSystemPrompt()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg shadow-md transition-colors">Set Prompt</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Universal AI Chat - Zero Build Architecture
         * Uses Vanilla JS, LocalStorage, and OpenRouter API
         */

        const app = {
            state: {
                chats: [],
                currentChatId: null,
                settings: {
                    apiKey: "",
                    model: "deepseek/deepseek-r1:free",
                    theme: "light"
                },
                isGenerating: false,
                abortController: null
            },

            // --- Initialization ---
            init() {
                this.loadState();
                this.applyTheme();
                this.setupMarkdown();
                
                // If no chats, create one
                if (this.state.chats.length === 0) {
                    this.createNewChat(false);
                } else {
                    // Ensure current ID exists
                    const exists = this.state.chats.find(c => c.id === this.state.currentChatId);
                    if (!exists) this.state.currentChatId = this.state.chats[0].id;
                }
                
                this.renderChatList();
                this.loadChat(this.state.currentChatId);

                // Fill settings inputs
                document.getElementById('api-key-input').value = this.state.settings.apiKey;
                document.getElementById('model-input').value = this.state.settings.model;
                this.updateModelDisplay();

                // Remove Loader
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);

                // Global Enter key handler for textarea
                document.getElementById('user-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSubmit(e);
                    }
                });
            },

            setupMarkdown() {
                marked.setOptions({
                    highlight: function(code, lang) {
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    },
                    langPrefix: 'hljs language-',
                    breaks: true,
                    gfm: true
                });
            },

            // --- State Management ---
            loadState() {
                try {
                    const saved = localStorage.getItem('universal-ai-chat');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.state.chats = parsed.chats || [];
                        this.state.currentChatId = parsed.currentChatId || null;
                        this.state.settings = { ...this.state.settings, ...(parsed.settings || {}) };
                    }
                } catch (e) {
                    console.error("State load failed", e);
                    localStorage.removeItem('universal-ai-chat');
                }
            },

            saveState() {
                try {
                    localStorage.setItem('universal-ai-chat', JSON.stringify({
                        chats: this.state.chats,
                        currentChatId: this.state.currentChatId,
                        settings: this.state.settings
                    }));
                } catch (e) {
                    console.error("Quota exceeded or error saving state", e);
                }
            },

            // --- Chat Logic ---
            createNewChat(switchImmediately = true) {
                const newChat = {
                    id: Date.now().toString(),
                    title: "New Chat",
                    messages: [],
                    systemPrompt: "",
                    createdAt: Date.now()
                };
                this.state.chats.unshift(newChat);
                if (switchImmediately) this.loadChat(newChat.id);
                this.saveState();
                this.renderChatList();
            },

            loadChat(chatId) {
                this.state.currentChatId = chatId;
                this.saveState();
                this.renderChatList();
                
                // Load messages
                const chat = this.getCurrentChat();
                if(chat) {
                   document.getElementById('system-prompt-input').value = chat.systemPrompt || "";
                }
                this.renderMessages();
                
                // Mobile: Close sidebar if open
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                    document.getElementById('sidebar-overlay').classList.add('hidden');
                }
            },

            getCurrentChat() {
                return this.state.chats.find(c => c.id === this.state.currentChatId);
            },

            deleteChat(e, chatId) {
                e.stopPropagation();
                if (!confirm("Delete this chat permanently?")) return;
                
                this.state.chats = this.state.chats.filter(c => c.id !== chatId);
                if (this.state.chats.length === 0) {
                    this.createNewChat(true);
                } else {
                    if (this.state.currentChatId === chatId) {
                        this.state.currentChatId = this.state.chats[0].id;
                        this.loadChat(this.state.currentChatId);
                    } else {
                        this.saveState();
                        this.renderChatList();
                    }
                }
            },

            renameChat(e, chatId) {
                e.stopPropagation();
                const chat = this.state.chats.find(c => c.id === chatId);
                if (!chat) return;
                
                const newTitle = prompt("Enter new chat name:", chat.title);
                if (newTitle && newTitle.trim()) {
                    chat.title = newTitle.trim();
                    this.saveState();
                    this.renderChatList();
                }
            },

            async handleSubmit(e) {
                if (e) e.preventDefault();
                if (this.state.isGenerating) return;

                const inputEl = document.getElementById('user-input');
                const text = inputEl.value.trim();
                if (!text) return;

                const chat = this.getCurrentChat();
                if (!chat) return;

                // Add User Message
                chat.messages.push({ role: 'user', content: text });
                inputEl.value = '';
                inputEl.style.height = 'auto'; // Reset height
                
                // Auto-Title Logic (if it's the first real message)
                if (chat.messages.length === 1 && chat.title === "New Chat") {
                    chat.title = text.slice(0, 30) + (text.length > 30 ? '...' : '');
                    this.renderChatList();
                }

                this.renderMessages();
                this.saveState();

                // Trigger AI
                await this.generateResponse(chat);
            },

            async generateResponse(chat) {
                this.state.isGenerating = true;
                this.state.abortController = new AbortController();
                
                const sendBtn = document.getElementById('send-btn');
                sendBtn.innerHTML = '<i class="fas fa-stop"></i>';
                sendBtn.onclick = (e) => { e.preventDefault(); this.stopGeneration(); };
                sendBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                sendBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

                // Add placeholder AI message
                const aiMsgId = Date.now();
                chat.messages.push({ role: 'assistant', content: '', id: aiMsgId });
                this.renderMessages(); // This creates the 'last-msg-content' div
                
                const messages = [];
                if (chat.systemPrompt) messages.push({ role: "system", content: chat.systemPrompt });
                // Clean messages for API (remove UI-specific IDs)
                messages.push(...chat.messages.filter(m => m.id !== aiMsgId).map(m => ({ role: m.role, content: m.content })));

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        signal: this.state.abortController.signal,
                        headers: {
                            "Authorization": `Bearer ${this.state.settings.apiKey}`,
                            "HTTP-Referer": window.location.origin,
                            "X-Title": "Universal AI Chat",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: this.state.settings.model,
                            messages: messages,
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        throw new Error(`API Error ${response.status}: ${errText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let aiText = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.slice(6);
                                if (dataStr === '[DONE]') break;

                                try {
                                    const json = JSON.parse(dataStr);
                                    const delta = json.choices[0]?.delta?.content || "";
                                    aiText += delta;
                                    
                                    // Live Update UI (Direct DOM manipulation for performance)
                                    const msgIndex = chat.messages.findIndex(m => m.id === aiMsgId);
                                    if (msgIndex !== -1) {
                                        chat.messages[msgIndex].content = aiText;
                                        this.updateLastMessage(aiText);
                                    }
                                } catch (e) { 
                                    // Ignore parse errors for partial chunks
                                }
                            }
                        }
                    }

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        const msgIndex = chat.messages.findIndex(m => m.id === aiMsgId);
                        if (msgIndex !== -1) {
                            chat.messages[msgIndex].content += `\n\n**Error:** ${error.message}. Please check your API Key settings.`;
                            this.renderMessages();
                        }
                    }
                } finally {
                    this.resetGenerationUI();
                    this.saveState();
                    // Final re-render to ensure markdown is perfect and cursor is gone
                    this.renderMessages(); 
                }
            },

            stopGeneration() {
                if (this.state.abortController) {
                    this.state.abortController.abort();
                    this.state.abortController = null;
                }
            },

            resetGenerationUI() {
                this.state.isGenerating = false;
                const sendBtn = document.getElementById('send-btn');
                sendBtn.innerHTML = '<i class="fas fa-paper-plane text-sm"></i>';
                sendBtn.onclick = null; // Revert to submit default
                sendBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                sendBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            },

            // --- Rendering ---
            renderChatList() {
                const list = document.getElementById('chat-list');
                list.innerHTML = this.state.chats.map(chat => `
                    <div onclick="app.loadChat('${chat.id}')" 
                         class="group flex items-center justify-between p-3 rounded-lg cursor-pointer text-sm mb-1 transition-colors ${this.state.currentChatId === chat.id ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-semibold' : 'hover:bg-slate-100 dark:hover:bg-white/5 text-slate-700 dark:text-slate-300'}">
                        <div class="truncate flex-1 pr-2">
                            <i class="far fa-message mr-2 opacity-70"></i> ${chat.title}
                        </div>
                        <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="app.renameChat(event, '${chat.id}')" class="p-1 hover:text-blue-500 transition-colors mr-1" title="Rename">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button onclick="app.deleteChat(event, '${chat.id}')" class="p-1 hover:text-red-500 transition-colors" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            renderMessages() {
                const container = document.getElementById('chat-container');
                const chat = this.getCurrentChat();
                
                if (!chat || chat.messages.length === 0) {
                    document.getElementById('welcome-message').style.display = 'flex';
                    container.innerHTML = ''; 
                    container.appendChild(document.getElementById('welcome-message'));
                    return;
                }

                document.getElementById('welcome-message').style.display = 'none';

                // Optimized rendering: Using innerHTML for simplicity in zero-build
                container.innerHTML = chat.messages.map((msg, idx) => {
                    const isAI = msg.role === 'assistant';
                    const isLast = idx === chat.messages.length - 1;
                    
                    // Parse Markdown safely
                    let contentHtml = "";
                    try {
                        contentHtml = marked.parse(msg.content);
                    } catch (e) {
                        contentHtml = msg.content;
                    }

                    return `
                    <div class="flex w-full mb-6 ${isAI ? 'justify-start' : 'justify-end'}">
                        <div class="max-w-[90%] md:max-w-[80%] min-w-[200px]">
                            ${isAI ? `
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white flex-shrink-0 text-xs shadow-md mt-1">
                                        <i class="fas fa-sparkles"></i>
                                    </div>
                                    <div class="prose dark:prose-invert text-sm md:text-base leading-relaxed overflow-hidden ${isLast && this.state.isGenerating ? 'typing-cursor' : ''}" id="${isLast ? 'last-msg-content' : ''}">
                                        ${contentHtml}
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-slate-100 px-5 py-3 rounded-2xl rounded-tr-sm shadow-sm text-sm md:text-base whitespace-pre-wrap">
                                    ${msg.content}
                                </div>
                            `}
                        </div>
                    </div>
                    `;
                }).join('');

                // Highlight code blocks
                container.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                this.scrollToBottom();
            },

            updateLastMessage(rawMarkdown) {
                const el = document.getElementById('last-msg-content');
                if (el) {
                    el.innerHTML = marked.parse(rawMarkdown);
                    // Re-highlight newly streamed code blocks
                    el.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    this.scrollToBottom();
                }
            },

            scrollToBottom() {
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            },

            // --- UI Actions ---
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            },

            toggleSettings() {
                const modal = document.getElementById('settings-modal');
                modal.classList.toggle('hidden');
            },

            saveSettings() {
                this.state.settings.apiKey = document.getElementById('api-key-input').value.trim();
                this.state.settings.model = document.getElementById('model-input').value.trim() || "deepseek/deepseek-r1:free";
                this.saveState();
                this.toggleSettings();
                this.updateModelDisplay();
            },

            updateModelDisplay() {
                const display = document.getElementById('current-model-display');
                let name = this.state.settings.model.split('/').pop();
                if(name.length > 20) name = name.substring(0, 18) + '...';
                display.innerHTML = `${name} <i class="fas fa-chevron-down text-xs"></i>`;
            },

            toggleTheme() {
                const html = document.documentElement;
                const icon = document.getElementById('theme-icon');
                
                if (this.state.settings.theme === 'light') {
                    this.state.settings.theme = 'dark';
                    html.classList.add('dark');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    this.state.settings.theme = 'light';
                    html.classList.remove('dark');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
                this.saveState();
            },

            applyTheme() {
                const html = document.documentElement;
                const icon = document.getElementById('theme-icon');
                if (this.state.settings.theme === 'dark') {
                    html.classList.add('dark');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            },

            toggleSystemPrompt() {
                document.getElementById('system-modal').classList.toggle('hidden');
            },

            saveSystemPrompt() {
                const val = document.getElementById('system-prompt-input').value.trim();
                const chat = this.getCurrentChat();
                if (chat) {
                    chat.systemPrompt = val;
                    this.saveState();
                }
                this.toggleSystemPrompt();
            }
        };

        // Start App when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
